<!DOCTYPE html>
<html lang="en">

<head>
    <title>Log in</title>
    <meta charset="utf-8">
    <meta name="format-detection" content="telephone=no" />
    <link rel="icon" href="assets/images/logo.png">
    <link rel="shortcut icon" href="assets/images/logo.png" />
    <link rel="stylesheet" href="assets/css/form.css">
    <link rel="stylesheet" href="assets/css/thumbs.css">
    <link rel="stylesheet" href="assets/css/slider.css">
    <link rel="stylesheet" href="assets/css/style.css">
    <script src="js/jquery.js"></script>
    <script src="js/jquery-migrate-1.2.1.js"></script>
    <script src="js/script.js"></script>
    <script src="js/superfish.js"></script>
    <script src="js/sForm.js"></script>
    <script src="js/jquery.ui.totop.js"></script>
    <script src="js/jquery.equalheights.js"></script>
    <script src="js/jquery.easing.1.3.js"></script>
    <script src="js/jquery.iosslider.min.js"></script>
    <script>
        $(document).ready(function () {
            $().UItoTop({ easingType: 'easeOutQuart' });
        });
    </script>
    <!--[if lt IE 8]>
	<div style=' clear: both; text-align:center; position: relative;'>
		<a href="http://windows.microsoft.com/en-US/internet-explorer/products/ie/home?ocid=ie6_countdown_bannercode">
			<img src="http://storage.ie6countdown.com/assets/100/images/banners/warning_bar_0000_us.jpg" border="0" height="42" width="820" alt="You are using an outdated browser. For a faster, safer browsing experience, upgrade for free today." />
		</a>
	</div>
	<![endif]-->
    <!--[if lt IE 9]>
	<script src="js/html5shiv.js"></script>
	<link rel="stylesheet" media="screen" href="css/ie.css">
	<![endif]-->
</head>

<body class="page1" id="top">

    <header>
        <div class="container_12">
            <div class="grid_12">
                <h1>
                    <a href="index.html">
                        <img src="assets/images/logo.png" alt="Your Happy Family">
                    </a>
                </h1>
            </div>
        </div>
    </header>
    <div class="container_12">
        <div class="grid_3">

        </div>
        <div class="grid_9">
            <h2>Log in</h2>
            <form id="formLogin">
                <div class="form-group">
                    <label>&nbsp;&nbsp;E-mail </label>
                    <input id="textEmail" class="form-control" type="email" placeholder="Your email address">
                    <label id="invalidEmail" style="color:red; font-size: 12px; display: none;">
                        <b>Please enter a valid email.</b>
                    </label>
                </div>
                <div class="form-group">
                    <label>&nbsp;Password</label>
                    <input id="textPassword" class="form-control" type="password" placeholder="Password must be between 6 and 14 digits long and include at least one numeric digit.">
                    <div>
                        <label id="invalidPassword" style="display: none;">
                            <b>Password must be between 6 and 14 digits long and include at least one numeric digit.</b>
                        </label>
                    </div>

                    <button id="btnLogin" class="btn btn-light" type="button">Log in</button>
                    <button id="btnSignUp" class="btn btn-light" type="button">Sign up</button>
                    <button id="btnLogout" class="btn btn-light" type="button" style="display: none;">Logout</button>
                </div>
            </form>
        </div>
    </div>
</body>

<script src="https://www.gstatic.com/firebasejs/5.5.4/firebase.js"></script>
<script type="text/javascript">
    // Initialize Firebase
    // FIXME: Hide api keys!!!!!
    var config = {
        apiKey: "AIzaSyAby5-flRUZH79bi_fxcUy_RlIi0MCm4zY",
        authDomain: "go-feed-me-project-2.firebaseapp.com",
        databaseURL: "https://go-feed-me-project-2.firebaseio.com",
        projectId: "go-feed-me-project-2",
        storageBucket: "go-feed-me-project-2.appspot.com",
        messagingSenderId: "771848633863"
    };
    firebase.initializeApp(config);

    // Set firebase auth state presistance 

    firebase.auth().setPersistence(firebase.auth.Auth.Persistence.SESSION)
        .then(function () {
            // Existing and future Auth states are now persisted in the current
            // session only. Closing the window would clear any existing state even
            // if a user forgets to sign out.
            // ...
            // New sign-in will be persisted with session persistence.
            return firebase.auth().signInWithEmailAndPassword(email, password);
        })
        .catch(function (error) {
            // Handle Errors here.
            var errorCode = error.code;
            var errorMessage = error.message;
        });

    // Get elements

    const textEmail = document.getElementById("textEmail");
    const textPassword = document.getElementById("textPassword");
    const btnLogin = document.getElementById("btnLogin");
    const btnSignUp = document.getElementById("btnSignUp");
    const btnLogout = document.getElementById("btnLogout");

    // Add email vailidation

    document.getElementById("textEmail").addEventListener("focusout", emailValidate);

    function emailValidate() {
        const invalidEmail = document.getElementById("invalidEmail");

        var pattern = /^[a-z0-9._%+-]+@[a-z0-9.-]+\.[a-z]{2,4}$/;

        if (pattern.test(textEmail.value) && textEmail.value !== "") {
            console.log("email validated");
            invalidEmail.setAttribute("style", "display: none");
            return true;
        } else {
            console.log("email not valid");
            invalidEmail.removeAttribute("style", "display: none");
            invalidEmail.setAttribute("style", "color:red; font-size: 12px;");
            return false;
        }
    };

    // Add password validadtion

    document.getElementById("textPassword").addEventListener("focusout", passwordValidate);

    function passwordValidate() {
        const invalidPassword = document.getElementById("invalidPassword");

        var pattern = /^(?=.*\d).{6,14}$/;

        if (pattern.test(textPassword.value) && textPassword.value !== "") {
            console.log("password validated");
            invalidPassword.setAttribute("style", "display: none");
            return true;
        } else {
            console.log("password not valid");
            invalidPassword.removeAttribute("style", "display: none");
            invalidPassword.setAttribute("style", "color:red; font-size: 12px;");
            return false;
        }
    };

    // Add log in event
    // TODO: let user know if they have successfully logged in or need to sign up 
    btnLogin.addEventListener("click", e => {
        // Get email and pass 
        const email = textEmail.value;
        const pass = textPassword.value;
        const auth = firebase.auth();
        // Log in 
        if (emailValidate() && passwordValidate()) {
            const promise = auth.signInWithEmailAndPassword(email, pass);

            promise.catch(e => console.log(e.massage));

            document.getElementById("formLogin").reset();
        }
    });

    // Add sign up event 
    // TODO: let user know they have successfully signed up  
    btnSignUp.addEventListener("click", e => {
        const email = textEmail.value;
        const pass = textPassword.value;
        const auth = firebase.auth();
        // Sign up
        if (emailValidate() && passwordValidate()) {
            const promise = auth.createUserWithEmailAndPassword(email, pass);

            promise.catch(e => console.log(e.massage));

            document.getElementById("formLogin").reset();
        }
    });

    // Add logout event 

    btnLogout.addEventListener("click", e => {
        firebase.auth().signOut();
        document.getElementById("formLogin").reset();
    })

    // Add/remove logout option

    firebase.auth().onAuthStateChanged(firebaseUser => {
        if (firebaseUser) {
            console.log(firebaseUser);
            btnLogout.removeAttribute("style");
            // window.location = "/home"
        } else {
            console.log("Not logged in");
            btnLogout.setAttribute("style", "display: none;");
            // window.location = "/"
        }
    });


</script>

</html>